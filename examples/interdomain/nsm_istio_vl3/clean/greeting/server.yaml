---
apiVersion: v1
kind: Service
metadata:
  name: greeting
  labels:
    app: greeting
    service: greeting
spec:
  ports:
    - port: 9080
      name: http
  selector:
    app: greeting
---
# apiVersion: v1
# kind: ConfigMap
# metadata:
#   namespace: default
#   name: cert-file
# data:
#   root-cert.pem: |
#     -----BEGIN CERTIFICATE-----
#     MIIC/DCCAeSgAwIBAgIQePWD4MtImMJuAefFgpWB7zANBgkqhkiG9w0BAQsFADAY
#     MRYwFAYDVQQKEw1jbHVzdGVyLmxvY2FsMB4XDTIyMTIwNzA2MTc1NFoXDTMyMTIw
#     NDA2MTc1NFowGDEWMBQGA1UEChMNY2x1c3Rlci5sb2NhbDCCASIwDQYJKoZIhvcN
#     AQEBBQADggEPADCCAQoCggEBAKEdAEae3jp1MjuIpRn2UXQjE7IzmCA/y0rRZ/ab
#     va5RczXC5/317IAYRdWkcE5ryNXH5E9wIYxYW7ZbiKdZTCfsqouStAUW8Go5A/0G
#     0Mton0VnCVb3x60H0hJ5jv4HmSUjdnVriSLqj1NbiocPAvTvQ/91ARi6ORH32dVs
#     n/+pwmDALstFU18SitKk+npoN32/21dhWqrWWgBolTJqoXfYha/zXWFASEe/5fwY
#     AP6ficIaLKUuDlbVsxiCa7qqxu21JGAqrhNhghT3Li8qC5svFRPCAdrY2TKnlQXA
#     lytdUhz+Hz3bLQiVUyMX1Gkyol+mhkkE+aeu1CtPHHIoYrsCAwEAAaNCMEAwDgYD
#     VR0PAQH/BAQDAgIEMA8GA1UdEwEB/wQFMAMBAf8wHQYDVR0OBBYEFLr0I3CiabVA
#     8HxGihmz1FIoIrjgMA0GCSqGSIb3DQEBCwUAA4IBAQBeU7MSGux8L/Dk5EfdaSOb
#     m5oIebtaq0XE8BASod6+EhzOlYn5rHjjAhXOYwc6yol/AzBlo63CPChkIe1ocU9X
#     jQ5MCLHr6Qsg8VN7/SakdP4qoHW4NyEZ4WysU7INfLzUYx9h/T6u8wZ81qIDgroJ
#     QbpbiUirp8z9YVZSmaeZ7KULi6WaMUB/05RyurdtINoZgNY/pHfXXtG80rbOA+/i
#     Ls2syt+//kz7s3f1XKEF0MyABVmNYoQhv33dZiNfPTaU1nMckDy7zTykTsCzPwSm
#     mEcCAGk91EZtDxfIycfEt+vVGnw9sf0IGOfeVfmqZBSylD0IyH/6+r33hBHoC+0R
#     -----END CERTIFICATE-----
#   cluster.env: |
#     CANONICAL_REVISION='latest'
#     CANONICAL_SERVICE='vm-app'
#     ISTIO_INBOUND_PORTS='*'
#     ISTIO_LOCAL_EXCLUDE_PORTS='22,15090,15021,15020'
#     ISTIO_METAJSON_LABELS='{"app":"vm-app","service.istio.io/canonical-name":"vm-app","service.istio.io/canonical-revision":"latest"}'
#     ISTIO_META_CLUSTER_ID='Kubernetes'
#     ISTIO_META_DNS_CAPTURE='true'
#     ISTIO_META_MESH_ID=''
#     ISTIO_META_NETWORK=''
#     ISTIO_META_WORKLOAD_NAME='vm-app'
#     ISTIO_NAMESPACE='vm-ns'
#     ISTIO_SERVICE='vm-app.vm-ns'
#     ISTIO_SERVICE_CIDR='*'
#     POD_NAMESPACE='vm-ns'
#     SERVICE_ACCOUNT='serviceaccountvm'
#     TRUST_DOMAIN='cluster.local'
#   istio-token: eyJhbGciOiJSUzI1NiIsImtpZCI6InJ4blU5UDVoWUtJZmFLSmk4a2FOQ0NvVUoycDNXXy00LTBTaHFxU0drWDQifQ.eyJhdWQiOlsiaXN0aW8tY2EiXSwiZXhwIjoxNjcwMzk3NTkyLCJpYXQiOjE2NzAzOTM5OTIsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJ2bS1ucyIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJzZXJ2aWNlYWNjb3VudHZtIiwidWlkIjoiNTcxOGZkZmQtYWI5Mi00MDhjLTg4NDYtZTliMjI5ZDA4ZjljIn19LCJuYmYiOjE2NzAzOTM5OTIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDp2bS1uczpzZXJ2aWNlYWNjb3VudHZtIn0.WowOSpFMODBKDFtHK1qoy2HS6i8mXET3zdEoVAGEKzDoCoDj00q7v7V3XDw0tD_fb8YvllTcrt0g1g98vU5qPWT1SxEiPKgu4SXNGHYjW68zUjJG-9y5W8aMLdOH6hevlkL9akQ2rgoyh7TClmZb9_-HcoawPE1BknqtkJzPMf5cRfgFIOQcbJjJkgZEAaaa3NrSCb2TXzQnt2HCMuO3wLJAPnjT-BCPJ-9FgBkzS-aJUmOUFWCts5g9Rstke608d9sCG5Y1rODZYqsao0XCvTwUvNfLfVYK2TRT0X34O6vbjsto2hlDhjwijKvmyR5IKHjowNB1qIo40NkCW-hqlA
#   mesh: |
#     defaultConfig:
#       discoveryAddress: istiod.istio-system.svc:15012
#       proxyMetadata:
#         CANONICAL_REVISION: latest
#         CANONICAL_SERVICE: vm-app
#         ISTIO_META_CLUSTER_ID: Kubernetes
#         ISTIO_META_DNS_CAPTURE: "true"
#         ISTIO_META_MESH_ID: ""
#         ISTIO_META_NETWORK: ""
#         ISTIO_META_WORKLOAD_NAME: vm-app
#         ISTIO_METAJSON_LABELS: '{"app":"vm-app","service.istio.io/canonical-name":"vm-app","service.istio.io/canonical-revision":"latest"}'
#         POD_NAMESPACE: vm-ns
#         SERVICE_ACCOUNT: serviceaccountvm
#         TRUST_DOMAIN: cluster.local
#       tracing:
#         zipkin:
#           address: zipkin.istio-system:9411
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: greeting
  labels:
    app: greeting
spec:
  replicas: 1
  selector:
    matchLabels:
      app: greeting
  template:
    metadata:
      labels:
        app: greeting
      annotations:
        networkservicemesh.io: kernel://my-vl3-network@my.cluster1/nsm-1?dnsName=server
    spec:
      hostAliases:
        - ip: "172.16.0.2"
          hostnames:
            - istiod.istio-system.svc
      volumes:
        - name: cert
          configMap:
            name: cert-file
      containers:
        - name: server
          image: hashicorp/http-echo:alpine
          args:
            - -text="hello world from istio"
            - -listen=:9080
          ports:
            - containerPort: 9080
              name: http
        - name: istio-proxy
          args:
            - proxy
            - sidecar
            - --domain
            - ""
            - --proxyLogLevel=info
            - --proxyComponentLogLevel=misc:info
            - --log_output_level=default:info
            - --concurrency
            - "0"
          env:
              - name: PILOT_CERT_PROVIDER
                value: NONE
              - name: CA_ADDR
                value: istiod.istio-system.svc:15012
              - name: POD_NAME
                valueFrom:
                  fieldRef:
                    apiVersion: v1
                    fieldPath: metadata.name
              - name: POD_NAMESPACE
                value: vm-ns
              - name: INSTANCE_IP
                valueFrom:
                  fieldRef:
                    apiVersion: v1
                    fieldPath: status.podIP
              - name: SERVICE_ACCOUNT
                value: serviceaccountvm
              - name: HOST_IP
                valueFrom:
                  fieldRef:
                    apiVersion: v1
                    fieldPath: status.hostIP
              - name: ISTIO_META_CLUSTER_ID
                value: Kubernetes
              - name: ISTIO_META_INTERCEPTION_MODE
                value: REDIRECT
              - name: ISTIO_META_WORKLOAD_NAME
                value: vm-app
              - name: ISTIO_META_MESH_ID
                value: cluster.local
              - name: TRUST_DOMAIN
                value: cluster.local
          image: docker.io/istio/proxyv2:1.15.2
          imagePullPolicy: IfNotPresent
          volumeMounts:
            - mountPath: /var/run/secrets/istio/root-cert.pem
              name: cert
              subPath: root-cert.pem
            - mountPath: /var/lib/istio/envoy/cluster.env
              name: cert
              subPath: cluster.env
            - mountPath: /etc/istio/config/mesh
              name: cert
              subPath: mesh.yaml
            - mountPath: /var/run/secrets/tokens/istio-token
              name: cert
              subPath: istio-token
          ports:
            - containerPort: 15090
              name: http-envoy-prom
              protocol: TCP
          readinessProbe:
            failureThreshold: 30
            httpGet:
              path: /healthz/ready
              port: 15021
              scheme: HTTP
            initialDelaySeconds: 1
            periodSeconds: 2
            successThreshold: 1
            timeoutSeconds: 3
          resources:
            limits:
              cpu: "2"
              memory: 1Gi
            requests:
              cpu: 100m
              memory: 128Mi
#      initContainers:
#        - args:
#                  - istio-iptables
#                  - -p
#                  - "15001"
#                  - -z
#                  - "15006"
#                  - -u
#                  - "1337"
#                  - -m
#                  - REDIRECT
#                  - -i
#                  - '*'
#                  - -x
#                  - ""
#                  - -b
#                  - '*'
#                  - -d
#                  - 15090,15021,15020
#          image: docker.io/istio/proxyv2:1.15.2
#          imagePullPolicy: IfNotPresent
#          name: istio-init
#          resources:
#            limits:
#                cpu: "2"
#                memory: 1Gi
#            requests:
#                cpu: 100m
#                memory: 128Mi
#          securityContext:
#            allowPrivilegeEscalation: false
#            capabilities:
#                add:
#                  - NET_ADMIN
#                  - NET_RAW
#                drop:
#                  - ALL
#            privileged: false
#            readOnlyRootFilesystem: false
#            runAsGroup: 0
#            runAsNonRoot: false
#            runAsUser: 0
